# T2-10-02 实现计划

## 任务信息

任务名称: Domain Sync by Account（Cloudflare Zone 同步）
任务级别: P0
执行位置: 控制端（go_cmdb）
前置任务: T2-10-01 已完成

## 核心原则

**同步域名 ≠ 启用 CDN**

所有新同步域名默认不可用于 CDN（purpose = unset）

## Phase 分解

### Phase 1: 分析任务需求并创建实现计划

- 阅读T2-10-02任务卡
- 理解业务规则（purpose规则、同步范围、幂等约束）
- 创建实现计划文档

### Phase 2: 实现Cloudflare Zone Client（ListZones）

文件: `internal/dns/providers/cloudflare/zones.go`

功能:
- 封装Cloudflare API: List Zones
- 返回字段: domain / provider_zone_id / name_servers
- 不包含DNS Record操作

实现要点:
- 复用现有Cloudflare client结构
- 使用api_keys表中的api_token
- 处理分页（如果有）
- 错误处理

### Phase 3: 实现Domain Sync Service（幂等同步逻辑）

文件: `internal/domain/sync_service.go`

功能:
- 幂等同步Cloudflare Zone到本地
- 业务规则集中处理
- 单zone单事务（避免大事务）

核心逻辑:
```go
func SyncDomainsByAPIKey(apiKeyID int) (total, created, updated int, err error) {
  1. 校验apiKeyID存在
  2. 校验api_keys.provider = cloudflare
  3. 调用Cloudflare API: List Zones
  4. 对每个zone:
     - 若domains.domain不存在 → 创建（purpose=unset）
     - upsert domain_dns_providers
     - upsert domain_dns_zone_meta（NS）
  5. 返回统计结果
}
```

业务规则:
- 新域名: purpose = unset
- 已存在域名: 不修改purpose
- NS变化: 覆盖
- provider_zone_id变化: 覆盖
- domain已绑定非cloudflare provider: 跳过并记录日志

### Phase 4: 实现API Handler和Router注册

文件: `api/v1/domains/handler.go` (新增)

路由: `POST /api/v1/domains/sync`

请求体:
```json
{
  "apiKeyId": 1
}
```

响应体:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 12,
    "created": 8,
    "updated": 4
  }
}
```

修改: `api/v1/router.go`
- 注册POST /api/v1/domains/sync路由

### Phase 5: 编写验收测试脚本并执行

文件: `scripts/test_t2_10_02.sh`

测试内容:
1. 准备测试数据（api_keys）
2. 调用同步API
3. SQL验证:
   - 新域名purpose = unset
   - NS已写入
   - last_sync_at更新
   - domain_dns_providers正确
4. 清理测试数据

### Phase 6: 运行go test和curl验证

验证内容:
- go test ./... 通过
- go build 编译成功
- curl测试同步API
- SQL验证数据正确性

### Phase 7: 生成交付报告并提交代码

交付物:
- Cloudflare zone client
- Domain sync service
- API handler + router
- 测试脚本
- 交付报告（必须说明purpose规则）

## 关键业务规则

### domains.purpose 规则

| 状态 | 含义 | 是否允许用于CDN CNAME |
|------|------|---------------------|
| unset | 未确认用途（默认） | 否 |
| cdn | 明确启用CDN | 是 |
| general | 明确不用于CDN | 否 |

本任务中:
- 新同步域名 → purpose = unset
- 已存在域名 → 不修改purpose

### 同步范围与映射规则

| Cloudflare字段 | 本地表 | 行为 |
|---------------|--------|------|
| zone.name | domains.domain | 不存在则创建 |
| 固定值 | domains.purpose | unset |
| zone.id | domain_dns_providers.provider_zone_id | 覆盖更新 |
| api_key.id | domain_dns_providers.api_key_id | 覆盖更新 |
| zone.name_servers | domain_dns_zone_meta.name_servers_json | 覆盖更新 |
| 当前时间 | domain_dns_zone_meta.last_sync_at | 必填 |

### 幂等与约束要求

- domains.domain 唯一
- domain_dns_providers.domain_id 唯一
- domain_dns_zone_meta.domain_id 唯一

同步行为约束:

| 场景 | 行为 |
|------|------|
| 已存在domain | 不修改purpose |
| NS变化 | 覆盖 |
| provider_zone_id变化 | 覆盖 |
| domain已绑定非cloudflare provider | 跳过并记录日志 |

## 明确禁止事项

本任务禁止:
- 自动将domain设为cdn
- 删除本地domain
- 修改purpose
- 自动解绑provider
- 创建DNS解析记录
- WebSocket推送
- 前端代码

## 验收标准

1. go test ./... 通过
2. go build 编译成功
3. curl测试同步API成功
4. SQL验证:
   - 新域名purpose = unset
   - NS已写入
   - last_sync_at更新
5. 交付报告完成

## 技术实现细节

### Cloudflare API

端点: `https://api.cloudflare.com/v4/zones`

请求头:
```
Authorization: Bearer <api_token>
Content-Type: application/json
```

响应示例:
```json
{
  "result": [
    {
      "id": "zone_id_xxx",
      "name": "example.com",
      "name_servers": ["ns1.cloudflare.com", "ns2.cloudflare.com"]
    }
  ],
  "success": true
}
```

### 数据库操作

1. 创建domain:
```sql
INSERT INTO domains (domain, purpose, status) 
VALUES ('example.com', 'unset', 'active')
ON DUPLICATE KEY UPDATE domain=domain;
```

2. Upsert domain_dns_providers:
```sql
INSERT INTO domain_dns_providers (domain_id, provider, provider_zone_id, api_key_id, status)
VALUES (?, 'cloudflare', ?, ?, 'active')
ON DUPLICATE KEY UPDATE 
  provider_zone_id=VALUES(provider_zone_id),
  api_key_id=VALUES(api_key_id),
  updated_at=NOW();
```

3. Upsert domain_dns_zone_meta:
```sql
INSERT INTO domain_dns_zone_meta (domain_id, name_servers_json, last_sync_at)
VALUES (?, ?, NOW())
ON DUPLICATE KEY UPDATE 
  name_servers_json=VALUES(name_servers_json),
  last_sync_at=NOW(),
  updated_at=NOW();
```

## 下一步任务预告

- T2-10-03: Domain List API（GET /domains）
- T2-10-04: 启用/禁用CDN（purpose切换）
