# B0-01-01 实现计划：发布模型与表结构

## 任务概述

创建发布系统的核心数据模型，包括release_tasks（发布任务）和release_task_nodes（发布任务节点）两张表。

## 核心目标

1. 创建两张MySQL表（release_tasks / release_task_nodes）
2. 实现GORM Model（一个表一个文件）
3. 配置数据库迁移
4. 验证表结构和约束
5. 编写验收测试（6+条SQL验证）

## 表结构设计

### 1. release_tasks（发布任务表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | pk auto_increment | 主键 |
| type | enum('apply_config') | not null | 任务类型 |
| target | enum('cdn') | not null | 目标类型 |
| version | bigint | not null, unique | 版本号（唯一） |
| status | enum | not null, default 'pending' | 状态 |
| total_nodes | int | not null, default 0 | 总节点数 |
| success_nodes | int | not null, default 0 | 成功节点数 |
| failed_nodes | int | not null, default 0 | 失败节点数 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

**status枚举值**: pending, running, success, failed, paused

**唯一约束**: unique(version)

### 2. release_task_nodes（发布任务节点表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | pk auto_increment | 主键 |
| release_task_id | bigint | not null, index | 发布任务ID |
| node_id | int | not null, index | 节点ID |
| batch | int | not null, default 1, index | 批次 |
| status | enum | not null, default 'pending', index | 状态 |
| error_msg | varchar(255) | null | 错误信息 |
| started_at | datetime | null | 开始时间 |
| finished_at | datetime | null | 完成时间 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

**status枚举值**: pending, running, success, failed, skipped

**唯一约束**: unique(release_task_id, node_id)

**索引**: release_task_id, node_id, batch, status

## 实现阶段

### Phase 1: 任务分析
- 创建实现计划文档
- 确认表结构和约束

### Phase 2: 创建release_tasks表
- 编写迁移SQL（migrations/011_create_release_tasks.sql）
- 实现GORM Model（internal/model/release_task.go）

### Phase 3: 创建release_task_nodes表
- 编写迁移SQL（migrations/012_create_release_task_nodes.sql）
- 实现GORM Model（internal/model/release_task_node.go）

### Phase 4: 配置迁移
- 添加Model到迁移列表（internal/db/migrate.go）
- 验证表创建

### Phase 5: 编写验收测试
- SHOW CREATE TABLE release_tasks
- SHOW CREATE TABLE release_task_nodes
- SHOW INDEX FROM release_tasks
- SHOW INDEX FROM release_task_nodes
- INSERT测试（正常插入）
- INSERT测试（唯一约束冲突）

### Phase 6: 生成交付报告
- 改动文件清单
- SQL验证结果
- 回滚策略

## 技术要点

1. **GORM Tag规范**:
   - 主键: `gorm:"primaryKey;autoIncrement"`
   - 唯一约束: `gorm:"uniqueIndex:uk_version"`
   - 索引: `gorm:"index:idx_release_task_id"`
   - 枚举: `gorm:"type:enum('pending','running','success','failed','paused');not null;default:pending"`

2. **时间字段**:
   - 使用 `time.Time` 或 `*time.Time`
   - GORM自动处理created_at和updated_at

3. **迁移方式**:
   - 使用AutoMigrate方式
   - 添加Model到internal/db/migrate.go的迁移列表

4. **验收测试**:
   - 至少6条SQL验证
   - 包含表结构、索引、插入、唯一约束测试

## 回滚策略

### 代码回滚
```bash
git revert <commit_hash>
```

### 数据库回滚
```sql
DROP TABLE IF EXISTS release_task_nodes;
DROP TABLE IF EXISTS release_tasks;
```

### 迁移回滚
从internal/db/migrate.go中移除两个Model。

## 验收标准

1. 控制端启动后两张表存在
2. unique/index生效
3. 可插入一条release_task + 两条release_task_nodes且不报错
4. 同release_task_id + node_id重复插入必须报错
5. go test ./... 通过
6. 至少6条SQL验证通过

## 禁止事项

1. 禁止使用图标（emoji）
2. 禁止出现yourapp/...等错误import
3. 禁止表名与字段名不匹配

## 交付清单

- [ ] migrations/011_create_release_tasks.sql
- [ ] migrations/012_create_release_task_nodes.sql
- [ ] internal/model/release_task.go
- [ ] internal/model/release_task_node.go
- [ ] internal/db/migrate.go（更新）
- [ ] scripts/test_release_models.sh（验收测试）
- [ ] docs/B0-01-01-DELIVERY.md（交付报告）
