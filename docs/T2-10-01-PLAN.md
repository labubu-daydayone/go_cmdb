# T2-10-01 实现计划

## 任务概述

任务名称：Domain Model + Migration（域名基础模型与NS缓存）
任务级别：P0
执行位置：控制端（go_cmdb）
前置任务：T2-08已完成

## 任务目标

只做数据结构与模型层建设，支撑后续：
- 域名列表展示
- DNS Provider绑定
- NS展示（只读）
- CDN域名用途控制

第一版要求：
- NS仅展示，不修改
- DNS Provider当前只实现Cloudflare，但结构必须支持多Provider

## 表结构设计

### 1. domains（域名主表）

用途：
- 域名基础数据
- 是否允许用于CDN

```sql
CREATE TABLE domains (
  id INT PRIMARY KEY AUTO_INCREMENT,
  domain VARCHAR(255) NOT NULL UNIQUE,
  purpose ENUM('cdn','general') NOT NULL DEFAULT 'cdn',
  status ENUM('active','inactive') NOT NULL DEFAULT 'active',
  created_at DATETIME,
  updated_at DATETIME
);
```

业务约束（代码层保证）：
- purpose = cdn：允许被 node_group / line_group / website 使用
- purpose = general：禁止用于CDN

### 2. domain_dns_providers（域名 ↔ DNS Provider 绑定）

用途：
- 标识域名当前由哪个DNS Provider管理
- 关联账号（api_keys）

```sql
CREATE TABLE domain_dns_providers (
  id INT PRIMARY KEY AUTO_INCREMENT,
  domain_id INT NOT NULL UNIQUE,
  provider ENUM('cloudflare','aliyun','tencent','huawei','manual') NOT NULL,
  provider_zone_id VARCHAR(128) NOT NULL,
  api_key_id INT NOT NULL,
  status ENUM('active','inactive') NOT NULL DEFAULT 'active',
  created_at DATETIME,
  updated_at DATETIME,
  KEY idx_domain_id (domain_id)
);
```

约束说明：
- 一个domain同一时间只能绑定一个provider
- 切换provider不在本任务范围

### 3. domain_dns_zone_meta（DNS Zone 元信息 / NS 缓存表）

用途：
- 缓存DNS Provider返回的NS
- 域名列表展示
- 判断DNS是否已接管

```sql
CREATE TABLE domain_dns_zone_meta (
  id INT PRIMARY KEY AUTO_INCREMENT,
  domain_id INT NOT NULL UNIQUE,
  name_servers_json JSON NOT NULL,
  last_sync_at DATETIME NOT NULL,
  last_error VARCHAR(255) NULL,
  created_at DATETIME,
  updated_at DATETIME,
  KEY idx_domain_id (domain_id)
);
```

字段说明：
- name_servers_json 示例：`["ns1.cloudflare.com","ns2.cloudflare.com"]`

第一版要求：
- 只读
- 不提供修改接口

## 实现计划（7个Phase）

### Phase 1: 分析任务需求并创建实现计划
- 阅读任务卡
- 设计表结构
- 规划实现步骤

### Phase 2: 创建Model层
创建以下文件：
- internal/model/domain.go
- internal/model/domain_dns_provider.go
- internal/model/domain_dns_zone_meta.go

要求：
- 使用GORM
- JSON字段使用datatypes.JSON
- 不写业务逻辑
- 不引入外部依赖

### Phase 3: 创建Migration文件
创建以下文件：
- migrations/010_create_domains.sql
- migrations/011_create_domain_dns_providers.sql
- migrations/012_create_domain_dns_zone_meta.sql

要求：
- 包含unique约束
- domain_id字段必须有index
- 不影响已有表

### Phase 4: 执行Migration并验证表结构
- SSH到测试环境
- 执行migration SQL
- 验证表结构正确

### Phase 5: 编写SQL验证脚本并测试
验证内容：
- 插入domains记录
- 插入domain_dns_providers记录
- 插入domain_dns_zone_meta记录
- 验证unique约束生效

### Phase 6: 运行go test验证编译
- 运行 `go test ./...`
- 确保编译通过
- 确保没有引入新的依赖问题

### Phase 7: 生成交付报告并提交代码
- 创建交付说明文档
- 提交代码到Git
- 生成文件列表

## 明确禁止事项

本任务严禁包含以下内容：
- Cloudflare API调用
- 域名同步逻辑
- DNS Worker
- NS修改接口
- CDN / Website / Node联动
- WebSocket / Socket.IO
- 前端代码

## 验收标准

1. 编译与测试
   - `go test ./...` 必须通过

2. 数据库基础验证
   - 插入domains记录成功
   - 插入domain_dns_providers记录成功
   - 插入domain_dns_zone_meta记录成功
   - unique约束生效

## 失败回滚策略

1. 数据库回滚
```sql
DROP TABLE domain_dns_zone_meta;
DROP TABLE domain_dns_providers;
DROP TABLE domains;
```

2. 代码回滚
```bash
git revert <commit_hash>
```

## 交付物要求

提交内容必须包含：
- Model文件（3个）
- Migration文件（3个）
- 简要交付说明文档（字段用途即可）
- 不得包含emoji / icon
- 不得包含DNS Provider业务代码

## 后续任务（不在本卡内）
- T2-10-02：按账号同步域名（Zone Sync）
- T2-10-03：域名列表API（展示NS / 账号）
- T2-10-04：purpose切换与CDN使用约束
