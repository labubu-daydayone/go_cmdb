# B0-01-02 实现计划：发布任务创建（节点选择 + 分批写入）

## 任务概述

实现发布任务创建功能，包括节点选择、分批策略、事务性创建发布任务、HTTP API。

## 核心目标

1. 实现节点选择规则（enabled=1, status='online', 按id升序）
2. 实现分批策略（batch=1取第1个节点，batch=2取剩余节点）
3. 实现事务性创建发布任务（version生成+批量写入）
4. 实现HTTP API（POST /api/v1/releases）
5. 编写验收测试（10+条SQL + 6+条curl）

## 节点选择规则

从nodes表选择节点：
- enabled = 1
- status = 'online'
- 按id升序排序（保证确定性）
- 若0个节点：返回业务错误（code=3003, HTTP 409, message="no online nodes"）

## 分批策略

固定策略（P0）：
- batch=1：取第1个节点（最少1个）
- batch=2：剩余所有节点
- 若只有1个节点：仅batch=1，不生成batch=2

## 创建发布任务流程

1. 生成新config_versions（version bigint自增）
2. 创建release_tasks：
   - type='apply_config'
   - target='cdn'
   - version=新version
   - status='pending'
   - total_nodes=选中节点数
3. 批量创建release_task_nodes：
   - release_task_id=新任务id
   - node_id=节点id
   - batch=按策略
   - status='pending'

要求：所有写入必须在同一个事务内，任何一步失败全部回滚。

## HTTP API

### POST /api/v1/releases

**请求体**:
```json
{
  "target": "cdn",
  "reason": "string optional"
}
```

**响应体（成功）**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "releaseId": 1,
    "version": 123456,
    "totalNodes": 5,
    "batches": [
      { "batch": 1, "nodeIds": [1] },
      { "batch": 2, "nodeIds": [2,3,4,5] }
    ]
  }
}
```

**权限/认证**:
- 必须走JWT中间件（非公开接口）
- 未登录返回401 + code=1001

## 实现阶段

### Phase 1: 任务分析
- 创建实现计划文档
- 确认节点选择规则和分批策略

### Phase 2: 创建release包结构
- internal/release/dto.go（请求/响应DTO）
- internal/release/selector.go（节点选择与分批）
- internal/release/service.go（CreateRelease入口）

### Phase 3: 实现节点选择规则和分批策略
- SelectOnlineNodes：查询enabled=1且status='online'的节点
- AllocateBatches：分配batch（batch=1取第1个，batch=2取剩余）

### Phase 4: 实现事务性创建发布任务
- GenerateVersion：生成新version（沿用T2-03方案）
- CreateRelease：事务性创建release_tasks + release_task_nodes

### Phase 5: 实现HTTP API
- api/v1/releases/handler.go（CreateRelease Handler）
- api/v1/router.go（注册路由）

### Phase 6: 编写验收测试
- 10+条SQL验证
- 6+条curl验证

### Phase 7: 生成交付报告
- 改动文件清单
- SQL验证结果
- curl验证结果
- 回滚策略

## 技术要点

### 1. 节点选择

```go
func SelectOnlineNodes(db *gorm.DB) ([]model.Node, error) {
    var nodes []model.Node
    err := db.Where("enabled = ? AND status = ?", 1, "online").
        Order("id ASC").
        Find(&nodes).Error
    return nodes, err
}
```

### 2. 分批策略

```go
func AllocateBatches(nodes []model.Node) []BatchAllocation {
    if len(nodes) == 0 {
        return nil
    }
    
    batches := []BatchAllocation{
        {Batch: 1, NodeIDs: []int{nodes[0].ID}},
    }
    
    if len(nodes) > 1 {
        remainingIDs := make([]int, len(nodes)-1)
        for i := 1; i < len(nodes); i++ {
            remainingIDs[i-1] = nodes[i].ID
        }
        batches = append(batches, BatchAllocation{
            Batch: 2,
            NodeIDs: remainingIDs,
        })
    }
    
    return batches
}
```

### 3. 事务性创建

```go
func (s *Service) CreateRelease(req *CreateReleaseRequest) (*CreateReleaseResponse, error) {
    var resp *CreateReleaseResponse
    
    err := s.db.Transaction(func(tx *gorm.DB) error {
        // 1. 生成version
        version, err := GenerateVersion(tx)
        if err != nil {
            return err
        }
        
        // 2. 选择节点
        nodes, err := SelectOnlineNodes(tx)
        if err != nil {
            return err
        }
        if len(nodes) == 0 {
            return httpx.ErrStateConflict.WithMessage("no online nodes")
        }
        
        // 3. 分配batch
        batches := AllocateBatches(nodes)
        
        // 4. 创建release_tasks
        task := &model.ReleaseTask{
            Type:       model.ReleaseTaskTypeApplyConfig,
            Target:     model.ReleaseTaskTarget(req.Target),
            Version:    version,
            Status:     model.ReleaseTaskStatusPending,
            TotalNodes: len(nodes),
        }
        if err := tx.Create(task).Error; err != nil {
            return err
        }
        
        // 5. 批量创建release_task_nodes
        for _, batch := range batches {
            for _, nodeID := range batch.NodeIDs {
                node := &model.ReleaseTaskNode{
                    ReleaseTaskID: task.ID,
                    NodeID:        nodeID,
                    Batch:         batch.Batch,
                    Status:        model.ReleaseTaskNodeStatusPending,
                }
                if err := tx.Create(node).Error; err != nil {
                    return err
                }
            }
        }
        
        // 6. 构造响应
        resp = &CreateReleaseResponse{
            ReleaseID:  task.ID,
            Version:    version,
            TotalNodes: len(nodes),
            Batches:    batches,
        }
        
        return nil
    })
    
    return resp, err
}
```

### 4. Version生成

沿用T2-03方案（如果已有config_versions表）：
```go
func GenerateVersion(tx *gorm.DB) (int64, error) {
    // 假设config_versions表存在
    // 如果不存在，使用时间戳或雪花算法
    var maxVersion int64
    err := tx.Model(&model.ConfigVersion{}).
        Select("COALESCE(MAX(version), 0)").
        Scan(&maxVersion).Error
    if err != nil {
        return 0, err
    }
    return maxVersion + 1, nil
}
```

## 验收测试

### SQL验证（10+条）

1. 插入3个online节点
2. 插入1个offline节点
3. 插入1个disabled节点
4. 创建发布任务（3个online节点）
5. 查询release_tasks（验证version/status/total_nodes）
6. 查询release_task_nodes（验证batch分组）
7. 验证batch=1只有1个节点
8. 验证batch=2有2个节点
9. 测试0个online节点（应失败）
10. 测试事务回滚（故意制造duplicate key）
11. 验证事务回滚后release_tasks不落库
12. 重复创建两次（验证version不同）

### curl验证（6+条）

1. 无token → 401
2. 0个online node → 409 + 3003
3. 1个online node → 只生成batch1
4. 3个online node → batch1=1个，batch2=2个
5. 重复调用两次 → version不同，releaseId不同
6. 故意制造DB失败 → release_tasks不落库（事务回滚证明）

## 禁止事项

1. 禁止调用Agent
2. 禁止在本任务执行apply_config/reload
3. 禁止引入新表（除非config_versions不存在）
4. 禁止出现yourapp/...等错误import
5. 禁止使用图标（emoji）

## 回滚策略

### 代码回滚
```bash
git revert <commit_hash>
```

### 数据回滚
```sql
DELETE FROM release_task_nodes WHERE release_task_id IN (SELECT id FROM release_tasks WHERE created_at > '2026-01-23 00:00:00');
DELETE FROM release_tasks WHERE created_at > '2026-01-23 00:00:00';
```

## 验收标准

1. 一次POST /api/v1/releases能生成release_tasks + release_task_nodes
2. 节点选择与batch分配符合规则
3. version生成稳定不冲突
4. 事务一致性严格成立
5. go test ./... 通过
6. 至少10条SQL验证通过
7. 至少6条curl验证通过

## 交付清单

- [ ] internal/release/dto.go
- [ ] internal/release/selector.go
- [ ] internal/release/service.go
- [ ] api/v1/releases/handler.go
- [ ] api/v1/router.go（更新）
- [ ] scripts/test_release_create.sh（验收测试）
- [ ] docs/B0-01-02-DELIVERY.md（交付报告）
