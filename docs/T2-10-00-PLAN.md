# T2-10-00 实现计划

## 任务信息

**任务名称**: API Keys（Cloudflare）管理接口补齐
**任务级别**: P0
**执行位置**: 控制端（go_cmdb）
**目标**: 让前端能通过接口完成 Cloudflare 账号密钥的新增/查询/启用停用/删除

## Phase 分解

### Phase 1: 分析任务需求并创建实现计划
- 阅读任务需求
- 理解安全要求（apiToken masked返回）
- 理解依赖检查要求（删除/停用时检查引用）
- 创建本文档

### Phase 2: 检查api_keys表结构并补充缺失字段
- 检查现有api_keys表结构
- 确认必需字段：id / name / provider / account / api_token / status / created_at / updated_at
- 如缺少字段，创建迁移文件并执行

### Phase 3: 实现Model层
- 创建/更新 internal/model/api_key.go
- 定义APIKey结构体
- 实现MaskedToken()方法（返回 ****+last4）
- 定义status枚举常量

### Phase 4: 实现Service层
- 创建 internal/api_keys/service.go
- 实现List（分页+搜索+过滤）
- 实现Create（参数校验）
- 实现Update（允许部分字段更新）
- 实现Delete（依赖检查）
- 实现ToggleStatus（依赖检查）
- 实现CheckDependencies（检查domain_dns_providers引用）

### Phase 5: 实现Handler层和Router注册
- 创建 api/v1/api_keys/handler.go
- 实现5个handler：
  * GET /api/v1/api-keys（列表）
  * POST /api/v1/api-keys/create
  * POST /api/v1/api-keys/update
  * POST /api/v1/api-keys/delete
  * POST /api/v1/api-keys/toggle-status
- 修改 api/v1/router.go 注册路由
- 确保所有接口走JWT middleware

### Phase 6: 编写验收测试脚本
- 创建 scripts/test_t2_10_00.sh
- 6条curl验收：
  1. 创建
  2. 列表
  3. 更新name/account
  4. 更新token（验证返回masked）
  5. toggle-status
  6. delete（含被引用时的失败用例）
- 4条SQL验证：
  1. select查看api_keys
  2. 验证token不被打印
  3. 引用检查：构造domain_dns_providers引用后delete失败
  4. toggle-status在被引用时失败

### Phase 7: 运行go test和验收测试
- 运行 go test ./...
- 运行 scripts/test_t2_10_00.sh
- 修复发现的问题

### Phase 8: 生成交付报告并提交代码
- 创建 docs/T2-10-00-DELIVERY.md
- 提交代码到Git
- 推送到GitHub

## 核心要求

### 1. 安全要求

**apiToken不允许明文返回**:
- 列表/详情响应：返回apiTokenMasked（****+last4）
- create/update成功响应：不返回明文token

### 2. 依赖检查

**删除/停用前必须检查引用**:
- 检查domain_dns_providers.api_key_id是否引用
- 被引用则禁止delete（返回3003或3002）
- 被引用则禁止inactive（返回409）

### 3. 接口规范

**路径风格**:
- GET /api/v1/api-keys
- POST /api/v1/api-keys/create
- POST /api/v1/api-keys/update
- POST /api/v1/api-keys/delete
- POST /api/v1/api-keys/toggle-status

**查询参数**:
- page（默认1）
- pageSize（默认20）
- keyword（匹配name/account）
- provider（默认cloudflare）
- status（active/inactive/all）

**请求体示例**:
```json
// create
{
  "name": "string",
  "provider": "cloudflare",
  "account": "string",
  "apiToken": "string"
}

// update
{
  "id": 1,
  "name": "string",
  "account": "string",
  "apiToken": "string",
  "status": "active"
}

// delete
{
  "ids": [1,2,3]
}

// toggle-status
{
  "id": 1,
  "status": "inactive"
}
```

**响应体示例**:
```json
// 列表
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "name": "my-cf-key",
        "provider": "cloudflare",
        "account": "user@example.com",
        "apiTokenMasked": "****abcd",
        "status": "active",
        "createdAt": "2026-01-24T00:00:00Z",
        "updatedAt": "2026-01-24T00:00:00Z"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20
  }
}

// create/update/delete/toggle-status
{
  "code": 0,
  "message": "success",
  "data": null
}

// 依赖检查失败
{
  "code": 3003,
  "message": "API Key is being used by 3 domains, cannot delete/disable",
  "data": null
}
```

## 数据库要求

### api_keys表结构

必需字段：
- id (bigint, primary key, auto_increment)
- name (varchar(255), not null)
- provider (enum('cloudflare'), not null)
- account (varchar(255), nullable)
- api_token (text, not null)
- status (enum('active','inactive'), not null, default 'active')
- created_at (datetime)
- updated_at (datetime)

### 依赖检查

检查表：domain_dns_providers
检查字段：api_key_id
检查逻辑：COUNT(*) WHERE api_key_id = ?

## 禁止事项

- 禁止出现任何 yourapp/... import
- 禁止把路由写到 /api/v2
- 禁止返回明文 apiToken
- 禁止跳过引用检查直接删除

## 失败回滚策略

### 代码回滚
```bash
git revert <commit>
```

### 数据回滚
- 若仅新增接口不动schema：无需回滚表
- 若新增迁移：提供对应down SQL（或手动revert alter）

## 验收标准

- [x] go test ./... 通过
- [ ] 6条curl验收通过
- [ ] 4条SQL验证通过
- [ ] 交付报告完成
