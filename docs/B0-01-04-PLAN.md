# B0-01-04 实现计划：发布任务查询接口

## 任务信息

- 任务编号：B0-01-04
- 任务名称：发布任务查询接口（列表/详情，可视化友好）
- 开发位置：控制端 go_cmdb
- 优先级：P0

## 核心目标

1. 实现发布任务列表API（分页+过滤）
2. 实现发布任务详情API（batch分组+node明细）
3. 计算skippedNodes和currentBatch
4. 优化查询性能（避免N+1）

## 关键技术点

### 1. skippedNodes计算

```sql
SELECT COUNT(*) FROM release_task_nodes
WHERE release_task_id = ? AND status = 'skipped'
```

### 2. currentBatch计算

规则：
- 取当前任务中最小的batch
- 该batch存在status in ('pending','running','failed')的记录
- 若全success则currentBatch=0

```sql
SELECT MIN(batch) FROM release_task_nodes
WHERE release_task_id = ? AND status IN ('pending', 'running', 'failed')
```

### 3. 列表查询（避免N+1）

```sql
SELECT
  rt.id, rt.type, rt.target, rt.version, rt.status,
  rt.total_nodes, rt.success_nodes, rt.failed_nodes,
  rt.created_at, rt.updated_at,
  (SELECT COUNT(*) FROM release_task_nodes WHERE release_task_id = rt.id AND status = 'skipped') as skipped_nodes,
  (SELECT MIN(batch) FROM release_task_nodes WHERE release_task_id = rt.id AND status IN ('pending', 'running', 'failed')) as current_batch
FROM release_tasks rt
WHERE status = ? (if filter)
ORDER BY id DESC
LIMIT ? OFFSET ?
```

### 4. 详情查询（batch分组+nodeName join）

```sql
-- 查询release_task
SELECT * FROM release_tasks WHERE id = ?

-- 查询release_task_nodes（JOIN nodes获取nodeName）
SELECT
  rtn.id, rtn.node_id, rtn.batch, rtn.status,
  rtn.error_msg, rtn.started_at, rtn.finished_at,
  n.name as node_name
FROM release_task_nodes rtn
LEFT JOIN nodes n ON rtn.node_id = n.id
WHERE rtn.release_task_id = ?
ORDER BY rtn.batch ASC, rtn.node_id ASC
```

## 实现阶段

### Phase 1: 任务分析
- 创建实现计划文档
- 分析API结构和计算规则

### Phase 2: 实现列表API
- 创建internal/release/query.go
- 实现ListReleases方法
- 实现skippedNodes和currentBatch计算
- 创建api/v1/releases/handler.go（ListReleases）
- 添加路由

### Phase 3: 实现详情API
- 实现GetReleaseDetail方法
- 实现batch分组逻辑
- 实现nodeName join
- 创建api/v1/releases/handler.go（GetReleaseDetail）
- 添加路由

### Phase 4: 优化查询性能
- 使用子查询避免N+1
- 使用LEFT JOIN获取nodeName
- 添加索引（如需要）

### Phase 5: 编写验收测试
- 12+条SQL验证
- 10+条curl验证

### Phase 6: 生成交付报告
- 文件清单
- 功能说明
- 验收结果

## API设计

### 1. GET /api/v1/releases（列表）

请求参数：
- status（可选）：pending/running/success/failed/paused
- page（可选，默认1）
- pageSize（可选，默认20，最大100）

响应结构：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "type": "apply_config",
        "target": "cdn",
        "version": 123456,
        "status": "running",
        "totalNodes": 5,
        "successNodes": 2,
        "failedNodes": 1,
        "skippedNodes": 0,
        "currentBatch": 2,
        "createdAt": "RFC3339",
        "updatedAt": "RFC3339"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20
  }
}
```

### 2. GET /api/v1/releases/:id（详情）

响应结构：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "release": {
      "id": 1,
      "type": "apply_config",
      "target": "cdn",
      "version": 123456,
      "status": "running",
      "totalNodes": 5,
      "successNodes": 2,
      "failedNodes": 1,
      "skippedNodes": 0,
      "currentBatch": 2,
      "createdAt": "RFC3339",
      "updatedAt": "RFC3339"
    },
    "batches": [
      {
        "batch": 1,
        "nodes": [
          {
            "nodeId": 1,
            "nodeName": "edge-01",
            "status": "success",
            "errorMsg": "",
            "startedAt": "RFC3339",
            "finishedAt": "RFC3339"
          }
        ]
      }
    ]
  }
}
```

## 计算规则

### skippedNodes
```
SELECT COUNT(*) FROM release_task_nodes
WHERE release_task_id = ? AND status = 'skipped'
```

### currentBatch
```
SELECT MIN(batch) FROM release_task_nodes
WHERE release_task_id = ? AND status IN ('pending', 'running', 'failed')
```

规则：
- 若全success则currentBatch=0（MIN返回NULL，处理为0）
- batch1 running → currentBatch=1
- batch1 success, batch2 pending → currentBatch=2

## 文件结构

```
internal/release/
  query.go          # 新增：列表/详情查询聚合
  service.go        # 已有：CreateRelease, GetRelease
  selector.go       # 已有：节点选择与分批
  dto.go            # 已有：请求/响应DTO
  executor.go       # 已有：发布执行器
  runner.go         # 已有：发布任务执行器

api/v1/releases/
  handler.go        # 修改：添加ListReleases和GetReleaseDetail

api/v1/
  router.go         # 修改：添加路由
```

## 验收测试

### SQL验证（12+条）
1. 插入release_tasks
2. 插入release_task_nodes（不同status）
3. 插入nodes
4. 验证skippedNodes计算
5. 验证currentBatch计算（全success）
6. 验证currentBatch计算（batch1 running）
7. 验证currentBatch计算（batch1 success, batch2 pending）
8. 验证列表分页
9. 验证status过滤
10. 验证batch分组
11. 验证nodeName join
12. 验证errorMsg处理

### curl验证（10+条）
1. 无token → 401
2. 列表分页（page=1, pageSize=10）
3. 列表分页（page=2, pageSize=5）
4. status过滤（status=running）
5. status过滤（status=success）
6. 详情返回batch分组正确
7. nodeName join正确
8. currentBatch在不同状态下正确（全success → 0）
9. currentBatch在不同状态下正确（batch1 running → 1）
10. currentBatch在不同状态下正确（batch1 success, batch2 pending → 2）

## 禁止事项

- 禁止写前端
- 禁止调用Agent
- 禁止修改executor逻辑（B0-01-03）
- 禁止使用图标

## 交付清单

- [ ] internal/release/query.go
- [ ] api/v1/releases/handler.go（ListReleases, GetReleaseDetail）
- [ ] api/v1/router.go（添加路由）
- [ ] scripts/test_release_query.sh（验收测试）
- [ ] docs/B0-01-04-DELIVERY.md（交付报告）
