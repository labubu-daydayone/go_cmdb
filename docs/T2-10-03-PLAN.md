# T2-10-03 实现计划

任务名称：Domain List API（域名列表查询）
任务级别：P0
执行位置：控制端（go_cmdb）

## 一、任务目标

提供一个稳定、可扩展、可直接给前端使用的域名列表查询接口，用于：
- 展示系统内所有域名资产
- 清晰区分：是否启用CDN（purpose）、使用哪个账号同步（api key）、当前NS状态
- 为T2-10-04（启用/禁用CDN）做前置支撑

## 二、核心设计原则

1. **只读** - 不修改任何表数据，不触发Cloudflare API
2. **聚合展示** - domains为主表，左连接provider/NS元数据
3. **purpose语义严格遵守** - unset/cdn/general，不做任何自动转换

## 三、实现Phase

### Phase 1: 分析任务需求并创建实现计划
- 理解接口定义和字段来源
- 明确聚合查询逻辑
- 确定禁止事项

### Phase 2: 实现Service层（ListDomains聚合查询）
文件: internal/domain/list_service.go

职责:
- 构造聚合查询（LEFT JOIN）
- 处理分页（page/pageSize）
- 处理过滤条件（keyword/purpose/provider/apiKeyId/status）
- 组装DTO

聚合SQL（示意）:
```sql
FROM domains d
LEFT JOIN domain_dns_providers p ON p.domain_id = d.id
LEFT JOIN api_keys ak ON ak.id = p.api_key_id
LEFT JOIN domain_dns_zone_meta zm ON zm.domain_id = d.id
WHERE ...
ORDER BY d.id DESC
LIMIT ? OFFSET ?
```

### Phase 3: 实现Handler层并注册路由
文件: api/v1/domains/handler.go

新增方法:
- ListDomains

路由:
- GET /api/v1/domains

### Phase 4: 编写验收测试脚本
文件: scripts/test_t2_10_03.sh

包含:
- SQL校验（purpose=unset的域名、NS不为空、apiKey name正确）
- curl验收（基本查询、purpose过滤、分页）

### Phase 5: 运行go test和curl验证
- go test ./... 通过
- curl验收通过

### Phase 6: 生成交付报告并提交代码
- 创建docs/T2-10-03-DELIVERY.md
- 提交代码到GitHub

## 四、接口定义

### GET /api/v1/domains

**查询参数（全部可选）**:
- page（int，默认1）
- pageSize（int，默认20）
- keyword（string，域名模糊搜索）
- purpose（string，unset/cdn/general）
- provider（string，cloudflare）
- apiKeyId（int，按账号筛选）
- status（string，active/inactive）

**返回结构**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "domain": "example.com",
        "purpose": "unset",
        "status": "active",
        "provider": "cloudflare",
        "apiKey": {
          "id": 1,
          "name": "cf-main"
        },
        "nameServers": [
          "ada.ns.cloudflare.com",
          "bob.ns.cloudflare.com"
        ],
        "lastSyncAt": "2026-01-24T10:00:00Z",
        "createdAt": "2026-01-20T08:00:00Z"
      }
    ],
    "total": 12,
    "page": 1,
    "pageSize": 20
  }
}
```

## 五、字段来源

| 字段 | 来源 |
|------|------|
| id | domains.id |
| domain | domains.domain |
| purpose | domains.purpose |
| status | domains.status |
| provider | domain_dns_providers.provider |
| apiKey.id | api_keys.id |
| apiKey.name | api_keys.name |
| nameServers | domain_dns_zone_meta.name_servers_json |
| lastSyncAt | domain_dns_zone_meta.last_sync_at |
| createdAt | domains.created_at |

## 六、明确禁止事项

- 禁止创建/更新domain
- 禁止修改purpose
- 禁止调用Cloudflare API
- 禁止WebSocket
- 禁止agent通信

## 七、验收标准

### 1. 编译
```bash
go test ./...
```

### 2. curl验收（至少）
```bash
# 基本查询
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8080/api/v1/domains?page=1&pageSize=10"

# purpose过滤
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8080/api/v1/domains?purpose=cdn"
```

### 3. SQL校验
- purpose=unset的域名能正确显示
- NS不为空（同步过的域名）
- apiKey name正确显示

## 八、失败回滚策略

- 仅新增接口代码
- 不涉及schema变更
- 回滚方式：`git revert <commit>`

## 九、完成后下一步任务

- T2-10-04：启用/禁用CDN（purpose切换+校验）
- T2-10-05：Domain Detail API（可选）
