package releases

import (
	"fmt"

	"go_cmdb/internal/httpx"
	"go_cmdb/internal/model"
	"go_cmdb/internal/release"

	"github.com/gin-gonic/gin"
	"gorm.io/gorm"
)

// Handler 发布API处理器
type Handler struct {
	service *release.Service
}

// NewHandler 创建发布API处理器
func NewHandler(db *gorm.DB) *Handler {
	return &Handler{
		service: release.NewService(db),
	}
}

// CreateRelease 创建发布任务
// POST /api/v1/releases
func (h *Handler) CreateRelease(c *gin.Context) {
	var req release.CreateReleaseRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		httpx.FailErr(c, httpx.ErrParamInvalid(err.Error()))
		return
	}

	// 验证target字段
	if req.Target != "cdn" {
		httpx.FailErr(c, httpx.ErrParamInvalid("target must be 'cdn'"))
		return
	}

	resp, err := h.service.CreateRelease(&req)
	if err != nil {
		// 如果是AppError，直接返回；否则包装为内部错误
		if appErr, ok := err.(*httpx.AppError); ok {
			httpx.FailErr(c, appErr)
		} else {
			httpx.FailErr(c, httpx.ErrInternalError("failed to create release", err))
		}
		return
	}

	httpx.OK(c, resp)
}

// GetReleaseDetail 获取发布任务详情
// GET /api/v1/releases/detail?id=xxx
func (h *Handler) GetReleaseDetail(c *gin.Context) {
	// 获取releaseID参数
	releaseIDStr := c.Query("id")
	if releaseIDStr == "" {
		httpx.FailErr(c, httpx.ErrParamInvalid("id is required"))
		return
	}

	// 转换为int64
	var id int64
	if _, err := fmt.Sscanf(releaseIDStr, "%d", &id); err != nil {
		httpx.FailErr(c, httpx.ErrParamInvalid("invalid id"))
		return
	}

	resp, err := h.service.GetReleaseDetail(id)
	if err != nil {
		// 如果是AppError，直接返回；否则包装为内部错误
		if appErr, ok := err.(*httpx.AppError); ok {
			httpx.FailErr(c, appErr)
		} else {
			httpx.FailErr(c, httpx.ErrInternalError("failed to get release", err))
		}
		return
	}

	httpx.OK(c, resp)
}

// ListReleases 查询发布任务列表
// GET /api/v1/releases
func (h *Handler) ListReleases(c *gin.Context) {
	var req release.ListReleasesRequest
	if err := c.ShouldBindQuery(&req); err != nil {
		httpx.FailErr(c, httpx.ErrParamInvalid(err.Error()))
		return
	}

	resp, err := h.service.ListReleases(&req)
	if err != nil {
		httpx.FailErr(c, httpx.ErrInternalError("failed to list releases", err))
		return
	}

	httpx.OK(c, resp)
}

// ListTasksRequest 列表请求
type ListTasksRequest struct {
	TargetType string `form:"targetType"`
	TargetID   int64  `form:"targetId"`
	Page       int    `form:"page"`
	PageSize   int    `form:"pageSize"`
}

// ListTasksResponse 列表响应
type ListTasksResponse struct {
	Items    []ReleaseTaskDTO `json:"items"`
	Total    int64            `json:"total"`
	Page     int              `json:"page"`
	PageSize int              `json:"pageSize"`
}

// ReleaseTaskDTO 发布任务 DTO
type ReleaseTaskDTO struct {
	ID          int64   `json:"id"`
	Status      string  `json:"status"`
	TargetType  string  `json:"targetType"`
	TargetID    int64   `json:"targetId"`
	ContentHash string  `json:"contentHash"`
	LastError   *string `json:"lastError"`
	CreatedAt   string  `json:"createdAt"`
	UpdatedAt   string  `json:"updatedAt"`
}

// List 查询发布任务列表
// GET /api/v1/releases/list
func (h *Handler) List(c *gin.Context) {
	var req ListTasksRequest
	if err := c.ShouldBindQuery(&req); err != nil {
		httpx.FailErr(c, httpx.ErrParamInvalid("invalid request"))
		return
	}

	// 默认分页参数
	if req.Page <= 0 {
		req.Page = 1
	}
	if req.PageSize <= 0 {
		req.PageSize = 20
	}

	// 构建查询
	query := h.service.GetDB().Model(&model.ReleaseTask{})

	if req.TargetType != "" {
		query = query.Where("target_type = ?", req.TargetType)
	}

	if req.TargetID > 0 {
		query = query.Where("target_id = ?", req.TargetID)
	}

	// 查询总数
	var total int64
	if err := query.Count(&total).Error; err != nil {
		httpx.FailErr(c, httpx.ErrDatabaseError("failed to count", err))
		return
	}

	// 查询列表
	var tasks []model.ReleaseTask
	offset := (req.Page - 1) * req.PageSize
	if err := query.Order("id DESC").Limit(req.PageSize).Offset(offset).Find(&tasks).Error; err != nil {
		httpx.FailErr(c, httpx.ErrDatabaseError("failed to query", err))
		return
	}

	// 转换为 DTO
	items := make([]ReleaseTaskDTO, 0, len(tasks))
	for _, task := range tasks {
		dto := ReleaseTaskDTO{
			ID:          task.ID,
			Status:      string(task.Status),
			TargetType:  task.TargetType,
			TargetID:    task.TargetID,
			ContentHash: task.ContentHash,
			CreatedAt:   task.CreatedAt.Format("2006-01-02T15:04:05+08:00"),
			UpdatedAt:   task.UpdatedAt.Format("2006-01-02T15:04:05+08:00"),
		}
		if task.LastError != nil {
			dto.LastError = task.LastError
		}
		items = append(items, dto)
	}

	httpx.OK(c, ListTasksResponse{
		Items:    items,
		Total:    total,
		Page:     req.Page,
		PageSize: req.PageSize,
	})
}
